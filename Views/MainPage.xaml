<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="_SPS.Views.MainPage"
             xmlns:viewmodels="clr-namespace:_SPS.ViewModels"
             xmlns:models="clr-namespace:_SPS.Models"
             Title="í™ˆ">

    <ContentPage.BindingContext>
        <viewmodels:MainViewModel />
    </ContentPage.BindingContext>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ðŸ“‚ ë‚´ ê¸€" Command="{Binding NavigateToMyUploadsCommand}" />
        <ToolbarItem Text="âž• ì¶”ê°€" Command="{Binding NavigateToAddPetCommand}" />
        <ToolbarItem Text="ë¡œê·¸ì•„ì›ƒ" Command="{Binding LogoutCommand}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, Auto, *">

        <VerticalStackLayout Grid.Row="0" Padding="20" Spacing="5" BackgroundColor="#f0f0f0">
            <Label Text="ë³´í˜¸ ì¤‘ì¸ ë™ë¬¼ë“¤" FontSize="22" FontAttributes="Bold" TextColor="Black"/>
            <Label Text="{Binding UserEmail, StringFormat='ì‚¬ìš©ìž: {0}'}" FontSize="14" TextColor="Gray"/>
        </VerticalStackLayout>

        <Border Grid.Row="1" Margin="10" Padding="10" StrokeShape="RoundRectangle 10" BackgroundColor="White" Stroke="LightGray">
            <VerticalStackLayout Spacing="10">

                <Button Text="ðŸ”½ ìƒì„¸ í•„í„° (ì—´ê¸°/ë‹«ê¸°)" 
                        TextColor="Blue" 
                        BackgroundColor="Transparent"
                        Command="{Binding ToggleFilterCommand}"/>

                <VerticalStackLayout IsVisible="{Binding IsFilterVisible}" Spacing="5" Padding="5">
                    <Grid ColumnDefinitions="*,*,*">
                        <Entry Grid.Column="0" Placeholder="í’ˆì¢…" Text="{Binding FilterBreed}"/>
                        <Entry Grid.Column="1" Placeholder="ë‚˜ì´" Text="{Binding FilterAge}" Keyboard="Numeric"/>
                        <Entry Grid.Column="2" Placeholder="ìƒíƒœ" Text="{Binding FilterCondition}"/>
                    </Grid>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Button Grid.Column="0" Text="ê²€ìƒ‰ ì ìš©" Command="{Binding ApplyFilterCommand}" BackgroundColor="#2D2B55"/>
                        <Button Grid.Column="1" Text="ì´ˆê¸°í™”" Command="{Binding ResetFilterCommand}" BackgroundColor="Gray"/>
                    </Grid>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </Border>

        <ActivityIndicator Grid.Row="2" IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" 
                           Color="Blue" VerticalOptions="Center" HorizontalOptions="Center" />

        <CollectionView Grid.Row="2" ItemsSource="{Binding Pets}" SelectionMode="None" Margin="10">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:PetModel">
                    <Frame Margin="0,5" Padding="10" CornerRadius="15" HasShadow="True" BorderColor="LightGray">
                        <Grid ColumnDefinitions="80, *, Auto" ColumnSpacing="10">

                            <Frame Grid.Column="0" Padding="0" CornerRadius="10" IsClippedToBounds="True" HeightRequest="80" WidthRequest="80">
                                <Image Source="{Binding ImageUrl}" Aspect="AspectFill" HeightRequest="80" WidthRequest="80" BackgroundColor="LightGray"/>
                            </Frame>

                            <VerticalStackLayout Grid.Column="1" Spacing="3" VerticalOptions="Center">
                                <Label Text="{Binding Name}" FontSize="18" FontAttributes="Bold" TextColor="Black"/>
                                <Label Text="{Binding Species, StringFormat='í’ˆì¢…: {0}'}" TextColor="#555"/>
                                <Label Text="{Binding Age, StringFormat='ë‚˜ì´: {0}ì‚´'}" TextColor="#555"/>
                                <Label Text="{Binding Location, StringFormat='ðŸ“ {0}'}" FontSize="11" TextColor="Gray" LineBreakMode="TailTruncation"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2" Spacing="10" VerticalOptions="Center">
                                <Button Text="ðŸ“ž" 
                                        FontSize="18"
                                        WidthRequest="50" HeightRequest="40"
                                        Padding="0"
                                        BackgroundColor="#6750A4"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=CallOwnerCommand}"
                                        CommandParameter="{Binding Contact}"/>

                                <Button Text="ï¼ž" 
                                        FontSize="18"
                                        WidthRequest="50" HeightRequest="40"
                                        Padding="0"
                                        BackgroundColor="Transparent" TextColor="Gray"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=GoToDetailCommand}"
                                        CommandParameter="{Binding .}"/>
                            </VerticalStackLayout>

                        </Grid>

                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=GoToDetailCommand}"
                                CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>